<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0" style="font-size: 1.75rem;">Saved Cities</h2>
    <%= link_to "Search New City", weather_search_path, class: "btn btn-primary" %>
  </div>

  <div class="row g-4">
    <% @cities.each do |city| %>
      <div class="col-12 col-md-6 col-lg-4">

        <div class="card border-1 shadow-sm h-100 rounded-4 d-flex flex-column">
          <div class="card-body d-flex flex-column p-4">

            <% forecast = city.forecasts.last %>

            <div class="d-flex justify-content-between align-items-center mb-1">
              <h5 class="fw-bold mb-0" style="font-size: 1.25rem; line-height: 1.2;"><%= city.name %></h5>

              <% if forecast %>
                <% if forecast['is_day'] == 1 %>
                  <span class="badge px-3 py-1 rounded-pill shadow-sm align-middle"
                        style="background-color: white; color: black; border: 1px solid #ddd; font-size: 0.85rem;">
                    ‚òÄÔ∏è Day
                  </span>
                <% else %>
                  <span class="badge px-3 py-1 rounded-pill shadow-sm align-middle"
                        style="background-color: #1b263b; color: white; font-size: 0.85rem;">
                    üåô Night
                  </span>
                <% end %>
              <% end %>
            </div>

            <p class="text-muted mb-3" style="font-size: 1rem; margin-top: -2px;"><%= city.country %></p>

            <div class="flex-grow-1"></div>

            <% if forecast %>
              <p class="text-center text-md-start mb-1 fw-semibold" style="font-size: 1rem;">
                <%= weather_description(forecast.weather_code) %>
              </p>
            <% end %>
            <p class="text-muted mb-2 text-center text-md-start" style="font-size: 0.95rem;">
              <strong>Local Time:</strong>
              <span class="live-time" data-timezone="<%= city.timezone %>">
                <%= Time.current.in_time_zone(city.timezone).strftime("%b %d, %Y %I:%M:%S %p") %>
              </span>
            </p>
            <div class="d-grid">
              <%= link_to "View Weather", city_path(city), class: "btn btn-outline-primary" %>
            </div>

          </div>
        </div>

      </div>
    <% end %>
  </div>

</div>

<script>
  function updateAllTimes() {
    document.querySelectorAll('.live-time').forEach(timeElement => {
      const timezone = timeElement.dataset.timezone;

      const now = new Date();
      const options = {
        timeZone: timezone,
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      };

      const formatter = new Intl.DateTimeFormat('en-US', options);
      timeElement.textContent = formatter.format(now);
    });
  }

  updateAllTimes();
  setInterval(updateAllTimes, 1000);
</script>
